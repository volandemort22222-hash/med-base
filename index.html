<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü™ñ –ë–∞–∑–∞ –ü–æ—Ä–∞–Ω–µ–Ω–∏—Ö ‚Äî –†–æ–∫—ñ—Ç</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #0b0b0b; color: white; padding: 15px; max-width: 850px; margin: auto; -webkit-overflow-scrolling: touch; }
        .card { background: #1c1c1c; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        input, select, button, textarea { width: 100%; padding: 14px; margin: 6px 0; font-size: 16px; border-radius: 10px; border: none; box-sizing: border-box; -webkit-appearance: none; }
        textarea { height: 110px; background: #2a2a2a; color: white; resize: none; }
        label { font-size: 14px; color: #aaa; margin-top: 10px; display: block; }
        
        button, .collapsible { cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; transition: 0.2s; min-height: 50px; font-weight: bold; }
        button:active { transform: scale(0.98); opacity: 0.8; }

        .pri-–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π { background: #c0392b !important; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .pri-—Ç–µ—Ä–º—ñ–Ω–æ–≤–∏–π { background: #f1c40f !important; color: black; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .pri-–∑–≤–∏—á–∞–π–Ω–∏–π { background: #7f8c8d !important; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }

        .collapsible { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .collapsible h3 { margin: 0; font-size: 18px; color: #0055ff; }
        .hidden { display: none; }

        .save-btn { background: #0055ff; color: white; }
        .folder-btn { background: #ff9900; color: black; }
        .quick-btn { background: #e74c3c; color: white; border: 2px solid #ff4444; }
        .view-btn { background: #27ae60; color: white; }
        .anal-btn { background: #3498db; color: white; }
        .support-btn { background: #2c3e50; color: white; border: 1px solid #34495e; }
        
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .green { background: #00ff66; } .red { background: #ff4444; }
        
        li { background: #2a2a2a; margin: 8px 0; padding: 12px; border-radius: 8px; display: flex; flex-direction: column; gap: 12px; border: 1px solid #333; }
        .item-main { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .item-actions { display: flex; gap: 6px; width: 100%; justify-content: flex-end; border-top: 1px solid #444; padding-top: 10px; flex-wrap: wrap; }
        .action-btn { width: auto; padding: 8px 12px; margin: 0; font-size: 13px; flex: 1; border-radius: 8px; min-height: 44px; border: none; }
        
        .pdf-btn { background: #ffffff !important; color: #000 !important; }
        .json-share-btn { background: #2c3e50 !important; color: #fff !important; }
        .edit-btn { background: #f1c40f !important; color: #000 !important; }
        .del-btn { background: #c0392b !important; color: #fff !important; }
        
        .media-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .media-grid img, .media-grid video { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #444; }

        .detail-line { margin: 6px 0; border-bottom: 1px solid #333; padding-bottom: 4px; color: #ccc; font-size: 13px; }
        .detail-line b { color: #fff; width: 180px; display: inline-block; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .stat-box { background: #2a2a2a; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #444; }
        .stat-num { font-size: 24px; font-weight: bold; color: #0055ff; display: block; }
        .stat-label { font-size: 12px; color: #aaa; }
        
        .home-btn { background: #444; color: white; margin-bottom: 15px; }
        .row-flex { display: flex; gap: 10px; align-items: flex-end; }
    </style>
</head>
<body>

<h2>ü™ñ –ë–∞–∑–∞ –ü–æ—Ä–∞–Ω–µ–Ω–∏—Ö</h2>

<div class="card" id="startMenu">
    <div class="row">
        <button class="folder-btn" onclick="initFolder()">üìÇ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</button>
        <button class="quick-btn" onclick="openQuickMode()">üì∏ –®–≤–∏–¥–∫–∞ —Ñ–æ—Ç–æ–∫–∞—Ä—Ç–∫–∞</button>
    </div>
    <button class="view-btn" onclick="document.getElementById('fileViewer').click()">üëÅÔ∏è –®–≤–∏–¥–∫–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ —Ñ–∞–π–ª—É (JSON)</button>
    <button class="anal-btn" onclick="handleAnalClick()">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ç–∞ –ó–≤—ñ—Ç–∏</button>
    <button class="support-btn" onclick="toggleSupport()">üõ†Ô∏è –¢–µ—Ö –ø—ñ–¥—Ç—Ä–∏–º–∫–∞</button>
    
    <input type="file" id="fileViewer" class="hidden" accept=".json" onchange="quickViewFile(event)">
    <div style="text-align: center; color: #555; font-size: 14px; margin-top: 10px; font-style: italic;">–ê–≤—Ç–æ—Ä ‚Äî –†–æ–∫—ñ—Ç</div>
</div>

<div id="supportArea" class="card hidden">
    <button class="home-btn" onclick="toggleSupport()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
    <div style="text-align: center; padding: 20px;">
        <h3>üìû –¢–µ—Ö–Ω—ñ—á–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞</h3>
        <p>–†–æ–∫—ñ—Ç</p>
        <a href="tel:+380683368105" style="color:#0055ff; font-size:20px; text-decoration:none; font-weight:bold;">üì± +380683368105</a>
    </div>
</div>

<div id="analyticsArea" class="hidden">
    <button class="home-btn" onclick="toggleAnalytics()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏ –ê–Ω–∞–ª—ñ—Ç–∏–∫—É</button>
    <div class="card">
        <h3>üìà –ü–æ—Ç–æ—á–Ω–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-num" id="statTotal">0</span><span class="stat-label">–í—Å—å–æ–≥–æ</span></div>
            <div class="stat-box"><span class="stat-num" id="statActive" style="color:#00ff66">0</span><span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ñ</span></div>
            <div class="stat-box"><span class="stat-num" id="statPriority" style="color:#ff4444">0</span><span class="stat-label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</span></div>
            <div class="stat-box"><span class="stat-num" id="statUrgent" style="color:#f1c40f">0</span><span class="stat-label">–¢–µ—Ä–º—ñ–Ω–æ–≤–æ</span></div>
        </div>

        <div class="card" style="background:#222; border:1px solid #444; margin-top:15px">
            <h3>üìÖ –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç –∑–∞ –ø–µ—Ä—ñ–æ–¥</h3>
            <div class="row-flex">
                <div style="flex:1"><label>–ó (–¥–∞—Ç–∞ —Ç–∞ —á–∞—Å):</label><input type="date" id="reportDateStart"><input type="time" id="reportTimeStart" value="00:00"></div>
                <div style="flex:1"><label>–ü–æ (–¥–∞—Ç–∞ —Ç–∞ —á–∞—Å):</label><input type="date" id="reportDateEnd"><input type="time" id="reportTimeEnd" value="23:59"></div>
            </div>
            <button class="pdf-btn" style="background:#fff; color:#000; margin-top:15px; font-weight:bold" onclick="generateDailyPDFReport()">üìÑ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ PDF –¢–∞–±–ª–∏—Ü—é</button>
        </div>
    </div>
</div>

<div id="mainInterface" class="hidden">
    <button class="home-btn" onclick="goHome()">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>

    <div class="card" id="formContainer">
        <div class="collapsible" onclick="toggleSec('formArea')">
            <h3 id="formTitle">üìù –ù–æ–≤–∞ –∫–∞—Ä—Ç–∫–∞</h3>
            <span>‚ñº</span>
        </div>
        <div id="formArea">
            <input id="pib" placeholder="–ü–Ü–ë">
            <input id="call" placeholder="–ü–æ–∑–∏–≤–Ω–∏–π">
            <input id="unit" placeholder="–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª">
            <input id="rank" placeholder="–ó–≤–∞–Ω–Ω—è">
            <input id="tagId" placeholder="–ù–æ–º–µ—Ä –∂–µ—Ç–æ–Ω—É">
            <input id="position" placeholder="–ü–æ—Å–∞–¥–∞">
            <div class="row"><label style="align-self:center; font-size:14px">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</label><input id="birthDate" type="date"></div>
            <input id="phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É">
            <input id="location" placeholder="–ú—ñ—Å—Ü–µ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞">
            <select id="severity">
                <option value="" disabled selected>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–æ—Ç–µ—Ä–ø—ñ–ª–æ–≥–æ</option>
                <option value="–∑–≤–∏—á–∞–π–Ω–∏–π">‚ö™ –∑–≤–∏—á–∞–π–Ω–∏–π</option>
                <option value="—Ç–µ—Ä–º—ñ–Ω–æ–≤–∏–π">üü° —Ç–µ—Ä–º—ñ–Ω–æ–≤–∏–π</option>
                <option value="–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π">üî¥ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π</option>
            </select>
            <div class="row"><label style="font-size:12px; color:#aaa;">–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è:</label><input id="date" type="date"></div>
            <div class="row"><label style="font-size:12px; color:#aaa;">–ß–∞—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è:</label><input id="time" type="time"></div>
            <input id="woundLocation" placeholder="–ú—ñ—Å—Ü–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è">
            <textarea id="circumstances" placeholder="–û–±—Å—Ç–∞–≤–∏–Ω–∏"></textarea>
            <textarea id="complaints" placeholder="–°–∫–∞—Ä–≥–∏"></textarea>
            <textarea id="help" placeholder="–ù–∞–¥–∞–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞"></textarea>
            <textarea id="medic" placeholder="–î–æ–ø–æ–º–æ–≥—É –Ω–∞–¥–∞–≤ (–ü—Ä—ñ–∑–≤–∏—â–µ/–ü–æ–∑–∏–≤–Ω–∏–π)"></textarea>
            <textarea id="vitals" placeholder="–ñ–∏—Ç—Ç—î–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏">–°–≤—ñ–¥–æ–º—ñ—Å—Ç—å -&#10;–¢–∏—Å–∫ -&#10;–ü—É–ª—å—Å -&#10;–°–∞—Ç—É—Ä–∞—Ü—ñ—è -&#10;–ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Ö–∞–Ω–Ω—è -</textarea>
            <input id="finalDiag" placeholder="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –¥—ñ–∞–≥–Ω–æ–∑">
            <select id="status"><option value="active">üü¢ –ê–∫—Ç–∏–≤–Ω–æ</option><option value="inactive">üî¥ –ù–µ –∞–∫—Ç–∏–≤–Ω–æ</option></select>
            
            <label style="font-size:12px; color:#aaa;">–ú–µ–¥—ñ–∞ (—Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ):</label>
            <input id="media" type="file" accept="image/*,video/*" multiple>
            
            <div class="row">
                <button class="save-btn" id="btnFileSave" style="display:none" onclick="saveData()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —É –ø–∞–ø–∫—É</button>
                <button class="quick-btn" id="btnCacheSave" style="display:none" onclick="saveQuickData()">‚ö° –ó–±–µ—Ä–µ–≥—Ç–∏ —É –∫–µ—à</button>
            </div>
            <button id="btnCancelEdit" class="hidden" onclick="cancelEdit()" style="background:#444">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="folderSearchUI" class="hidden">
        <div id="searchBlock" class="card">
            <div class="collapsible" onclick="toggleSec('filterArea')">
                <h3>üîç –ü–æ—à—É–∫ —Ç–∞ –§—ñ–ª—å—Ç—Ä–∏</h3>
                <span>‚ñº</span>
            </div>
            <div id="filterArea">
                <input id="searchPIB" placeholder="–ü–æ—à—É–∫ –ü–Ü–ë / –ü–æ–∑–∏–≤–Ω–∏–π..." oninput="render()">
                <div class="row">
                    <select id="fStatus" onchange="render()"><option value="">–£—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option><option value="active">–ê–∫—Ç–∏–≤–Ω–æ</option><option value="inactive">–ê—Ä—Ö—ñ–≤</option></select>
                    <select id="fSeverity" onchange="render()"><option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option><option value="–∑–≤–∏—á–∞–π–Ω–∏–π">–ó–≤–∏—á–∞–π–Ω–∏–π</option><option value="—Ç–µ—Ä–º—ñ–Ω–æ–≤–∏–π">–¢–µ—Ä–º—ñ–Ω–æ–≤–∏–π</option><option value="–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π</option></select>
                </div>
                <div class="row"><label style="align-self:center; font-size:14px">–î–∞—Ç–∞ –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è:</label><input id="fDate" type="date" onchange="render()"></div>
                <input id="searchLoc" placeholder="–ü–æ—à—É–∫ –∑–∞ –º—ñ—Å—Ü–µ–º –ø–∞—Ü—ñ—î–Ω—Ç–∞..." oninput="render()">
            </div>
        </div>
    </div>

    <div class="card">
        <h3 id="listTitle">üìã –°–ø–∏—Å–æ–∫</h3>
        <ul id="mainListArea" style="padding:0;list-style:none"></ul>
    </div>
</div>

<div id="details" class="card hidden"></div>

<script>
let directoryHandle = null, cards = [], quickCards = JSON.parse(localStorage.getItem('quick_med_data') || '[]');
let editFileName = null, editQuickIndex = null, myCharts = {};
const fields = ['pib','call','unit','rank','tagId','position','birthDate','phone','location','severity','date','time','woundLocation','circumstances','complaints','help','medic','vitals','finalDiag','status'];

const langMap = { 
    pib: {uk:"–ü–Ü–ë", en:"Full Name"}, call: {uk:"–ü–æ–∑–∏–≤–Ω–∏–π", en:"Callsign"}, unit: {uk:"–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª", en:"Unit"}, rank: {uk:"–ó–≤–∞–Ω–Ω—è", en:"Rank"}, tagId: {uk:"–ñ–µ—Ç–æ–Ω", en:"ID Tag Number"}, position: {uk:"–ü–æ—Å–∞–¥–∞", en:"Position"}, birthDate: {uk:"–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", en:"Date of Birth"}, phone: {uk:"–¢–µ–ª", en:"Phone Number"}, location: {uk:"–ú—ñ—Å—Ü–µ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞", en:"Patient Location"}, severity: {uk:"–ö–∞—Ç–µ–≥–æ—Ä—ñ—è", en:"Triage Category"}, date: {uk:"–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è", en:"Date of Injury"}, time: {uk:"–ß–∞—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è", en:"Time of Injury"}, woundLocation: {uk:"–ú—ñ—Å—Ü–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è", en:"Place of Injury"}, circumstances: {uk:"–û–±—Å—Ç–∞–≤–∏–Ω–∏", en:"Circumstances"}, complaints: {uk:"–°–∫–∞—Ä–≥–∏", en:"Complaints"}, help: {uk:"–ù–∞–¥–∞–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞", en:"Treatment"}, medic: {uk:"–î–æ–ø–æ–º–æ–≥—É –Ω–∞–¥–∞–≤", en:"Medic/Provider"}, vitals: {uk:"–ü–æ–∫–∞–∑–Ω–∏–∫–∏", en:"Vital Signs"}, finalDiag: {uk:"–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –¥—ñ–∞–≥–Ω–æ–∑", en:"Preliminary Diagnosis"}, status: {uk:"–°—Ç–∞—Ç—É—Å", en:"Status"} 
};

function formatDate(val) { if(!val) return "---"; const [y, m, d] = val.split('-'); return `${d}.${m}.${y}`; }
function toggleSec(id) { document.getElementById(id).classList.toggle('hidden'); }
function goHome() { location.reload(); }
function toggleSupport() { document.getElementById('supportArea').classList.toggle('hidden'); document.getElementById('startMenu').classList.toggle('hidden'); }

async function handleAnalClick() { try { directoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' }); await loadFiles(); toggleAnalytics(); } catch(e){} }
function toggleAnalytics() { 
    document.getElementById('analyticsArea').classList.toggle('hidden'); 
    document.getElementById('startMenu').classList.toggle('hidden'); 
    if(!document.getElementById('analyticsArea').classList.contains('hidden')) {
        calculateStats();
        const now = new Date().toISOString().split('T')[0];
        document.getElementById('reportDateStart').value = now;
        document.getElementById('reportDateEnd').value = now;
    }
}

function calculateStats() {
    const d = cards;
    document.getElementById('statTotal').innerText = d.length;
    document.getElementById('statActive').innerText = d.filter(c => c.status==='active').length;
    document.getElementById('statPriority').innerText = d.filter(c => c.severity==='–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π').length;
    document.getElementById('statUrgent').innerText = d.filter(c => c.severity==='—Ç–µ—Ä–º—ñ–Ω–æ–≤–∏–π').length;
}

async function initFolder() {
    try {
        directoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        document.getElementById('startMenu').classList.add('hidden');
        document.getElementById('mainInterface').classList.remove('hidden');
        document.getElementById('btnFileSave').style.display = 'block';
        document.getElementById('folderSearchUI').classList.remove('hidden');
        document.getElementById('listTitle').innerText = "üìã –°–ø–∏—Å–æ–∫ –±–∞–∑–∏ (–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è)";
        await loadFiles(); render();
    } catch(e){}
}

async function loadFiles() {
    cards = []; if(!directoryHandle) return;
    for await (const entry of directoryHandle.values()) {
        if(entry.name.endsWith('.json')) { const f = await entry.getFile(); try { let d = JSON.parse(await f.text()); d._fileName = entry.name; cards.push(d); } catch(e){} }
    }
}

async function saveData() {
    const d = await getFormData();
    const name = editFileName || `${d.call || d.pib || 'Med'}-${Date.now()}.json`;
    const h = await directoryHandle.getFileHandle(name, {create:true});
    const w = await h.createWritable(); await w.write(JSON.stringify(d, null, 2)); await w.close();
    cancelEdit(); await loadFiles(); render();
}

async function getFormData() {
    let d = {}; fields.forEach(f => d[f] = document.getElementById(f).value);
    const files = document.getElementById('media').files;
    if(files.length) d.media = await Promise.all(Array.from(files).map(f => new Promise(r => { const rd = new FileReader(); rd.onload = () => r({data:rd.result, type:f.type}); rd.readAsDataURL(f); })));
    else { d.media = d.media || []; }
    return d;
}

function render(isQuick = false) {
    const list = document.getElementById('mainListArea'); list.innerHTML = "";
    const dataSrc = isQuick ? quickCards : cards;
    const fS = document.getElementById('fStatus').value, fV = document.getElementById('fSeverity').value, fP = document.getElementById('searchPIB').value.toLowerCase(), fD = document.getElementById('fDate').value, fL = document.getElementById('searchLoc').value.toLowerCase();
    
    dataSrc.filter(d => {
        if(isQuick) return true;
        return (!fS || d.status === fS) && (!fV || d.severity === fV) && (!fP || (d.pib+d.call).toLowerCase().includes(fP)) && (!fD || d.date === fD) && (!fL || (d.location||'').toLowerCase().includes(fL));
    }).sort((a,b)=>new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time)).forEach((d, i) => {
        const li = document.createElement('li'); const realIdx = dataSrc.indexOf(d);
        li.innerHTML = `<div class="item-main" onclick="showDetails(${realIdx}, ${isQuick})"><span><span class="status-dot ${d.status==='active'?'green':'red'}"></span><b>${d.call||d.pib||'---'}</b></span><span class="pri-${d.severity}">${d.severity||''}</span></div>
        <div class="item-actions">
            <button class="action-btn pdf-btn" onclick="printPDF(${realIdx}, ${isQuick})">üñ®Ô∏è PDF</button>
            <button class="action-btn json-share-btn" onclick="shareAsJSON(${realIdx}, ${isQuick})">üìÑ JSON</button>
            <button class="action-btn edit-btn" onclick="editCard(${realIdx}, ${isQuick})">‚úèÔ∏è</button>
            <button class="action-btn del-btn" onclick="${isQuick ? 'deleteQuick' : 'deleteCard'}(${realIdx})">üóëÔ∏è</button>
        </div>`;
        list.appendChild(li);
    });
}

async function shareAsJSON(i, isQ) { 
    const d = isQ ? quickCards[i] : cards[i]; 
    const blob = new Blob([JSON.stringify(d, null, 2)], {type:'application/json'}); 
    const file = new File([blob], `${d.call || 'med'}.json`, {type:'application/json'}); 
    if(navigator.share) try { await navigator.share({files:[file]}); return; } catch(e){}
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${d.call || 'med'}.json`; a.click();
}

function printPDF(i, isQ) {
    const d = isQ ? quickCards[i] : cards[i]; const w = window.open();
    let mediaHtml = "";
    if (d.media && d.media.length > 0) {
        mediaHtml = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">`;
        d.media.forEach(m => { if(m.type.includes('image')) mediaHtml += `<img src="${m.data}" style="width:100%; border:1px solid #000; height:200px; object-fit:cover;">`; });
        mediaHtml += `</div>`;
    }
    
    let c = `<html><head><style>
        body{font-family:Arial;padding:40px; color:#000; line-height:1.4;} 
        .header { margin-bottom: 20px; border-bottom: 3px solid #000; padding-bottom: 10px; }
        .l{border-bottom:1px solid #ccc;padding:6px 0; font-size:11pt;} 
        .uk { font-weight: bold; }
        .en { font-size: 9pt; font-style: italic; color: #444; margin-left: 5px; }
        h1{margin: 0; font-size: 20pt; font-weight: bold;} 
        .stamp{margin-top:30px; text-align:right; font-style:italic; font-size:9pt;}
    </style></head><body>
    <div class="header"><h1>–ö–ê–†–¢–ö–ê –ü–û–†–ê–ù–ï–ù–û–ì–û<br><span style="font-size:14pt; font-style:italic; font-weight:normal;">CASUALTY CARD</span></h1></div>
    <h3 style="margin-bottom:15px;">${d.pib || '____________________'} ${d.call ? '('+d.call+')' : ''}</h3>`;
    
    fields.forEach(f => { 
        let val = d[f] || '---'; 
        if(f === 'date' || f === 'birthDate') val = formatDate(d[f]); 
        c += `<div class="l"><span class="uk">${langMap[f].uk}:</span> <span class="en">/ ${langMap[f].en}</span><br>${val}</div>`; 
    });
    
    c += mediaHtml + `<div class="stamp">–î–æ–ø–æ–º–æ–≥—É –Ω–∞–¥–∞–≤: ${d.medic || '___________'}<br>–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: ${new Date().toLocaleString()}</div>`;
    w.document.write(c + `<script>window.onload=()=> {window.print();window.close();}<\/script></body></html>`); w.document.close();
}

function generateDailyPDFReport() {
    const dStart = document.getElementById('reportDateStart').value;
    const tStart = document.getElementById('reportTimeStart').value;
    const dEnd = document.getElementById('reportDateEnd').value;
    const tEnd = document.getElementById('reportTimeEnd').value;

    if(!dStart || !dEnd) { alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –ø–æ—á–∞—Ç–∫–æ–≤—É —Ç–∞ –∫—ñ–Ω—Ü–µ–≤—É –¥–∞—Ç–∏."); return; }

    const fullStart = new Date(`${dStart}T${tStart}`);
    const fullEnd = new Date(`${dEnd}T${tEnd}`);

    const filtered = cards.filter(c => {
        const cDate = new Date(`${c.date}T${c.time}`);
        return cDate >= fullStart && cDate <= fullEnd;
    });

    if(!filtered.length) { alert("–ó–∞ –≤–∫–∞–∑–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ."); return; }
    
    const w = window.open();
    let h = `<html><head><style>
        @page { size: landscape; margin: 5mm; } 
        body{font-family:Arial;padding:5px;font-size:6.5pt; color:#000;} 
        .header-rep { border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom:10px;}
        table{width:100%; border-collapse:collapse; table-layout: auto;} 
        th,td{border:1px solid #000; padding:2px; text-align:left; word-wrap: break-word;} 
        th{background:#eee; font-weight:bold; text-align:center;} 
        .pri-–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π{color:red; font-weight:bold;}
    </style></head><body>
    <div class="header-rep">
        <h1 style="margin:0; font-size:12pt;">–ó–í–Ü–¢ –ü–û –ü–û–†–ê–ù–ï–ù–ò–ú –ó–ê –ü–ï–†–Ü–û–î</h1>
        <p style="margin:0; font-size:9pt;">–ü–µ—Ä—ñ–æ–¥: ${formatDate(dStart)} ${tStart} ‚Äî ${formatDate(dEnd)} ${tEnd}</p>
    </div>`;
    
    h += `<table><thead><tr><th>–î–∞—Ç–∞/–ß–∞—Å –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è</th><th style="min-width:60px">–ü–Ü–ë / –ü–æ–∑–∏–≤–Ω–∏–π</th><th>–ó–≤–∞–Ω–Ω—è / –ü—ñ–¥—Ä.</th><th>–ö–∞—Ç.</th><th style="width:15%">–°–∫–∞—Ä–≥–∏ / –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –¥—ñ–∞–≥–Ω–æ–∑</th><th style="width:15%">–ú—ñ—Å—Ü–µ –ø–æ—Ä–∞–Ω–µ–Ω–Ω—è / –û–±—Å—Ç–∞–≤–∏–Ω–∏</th><th>–ü–æ–∫–∞–∑–Ω–∏–∫–∏</th><th style="width:15%">–î–æ–ø–æ–º–æ–≥–∞</th><th>–ú–µ–¥–∏–∫</th><th>–ó–∞—Ä–∞–∑</th></tr></thead><tbody>`;
    filtered.forEach(x => { h += `<tr><td>${formatDate(x.date)}<br>${x.time}</td><td>${x.pib}<br><b>${x.call||''}</b></td><td>${x.rank || ''}<br>${x.unit || ''}</td><td class="pri-${x.severity}">${x.severity}</td><td>${x.complaints}<br><i>${x.finalDiag || ''}</i></td><td><b>${x.woundLocation || ''}</b><br>${x.circumstances || ''}</td><td>${x.vitals.replace(/\n/g, ' ')}</td><td>${x.help}</td><td>${x.medic || ''}</td><td>${x.location || ''}</td></tr>`; });
    h += `</tbody></table><script>window.onload=()=> {window.print();window.close();}<\/script></body></html>`;
    w.document.write(h); w.document.close();
}

function showDetails(i, isQ, isDirect = false) {
    const d = isDirect ? i : (isQ ? quickCards[i] : cards[i]);
    const b = document.getElementById('details'); b.classList.remove('hidden');
    let m = '<div class="media-grid">'; (d.media||[]).forEach(x => m += x.type.includes('video') ? `<video controls src="${x.data}"></video>` : `<img src="${x.data}">`);
    let content = `<h3>${d.pib||d.call}</h3>`;
    fields.forEach(f => { let val = d[f] || ''; if(f === 'date' || f === 'birthDate') val = formatDate(d[f]); content += `<div class="detail-line"><b>${langMap[f].uk}:</b> ${val}</div>`; });
    b.innerHTML = content + m + `</div><button class="action-btn del-btn" onclick="this.parentElement.parentElement.classList.add('hidden')">–ó–∞–∫—Ä–∏—Ç–∏</button>`;
    b.scrollIntoView({behavior:'smooth'});
}

function openQuickMode() { document.getElementById('startMenu').classList.add('hidden'); document.getElementById('mainInterface').classList.remove('hidden'); document.getElementById('btnCacheSave').style.display='block'; document.getElementById('folderSearchUI').classList.add('hidden'); document.getElementById('listTitle').innerText = "üìã –°–ø–∏—Å–æ–∫ (–ö–µ—à –±—Ä–∞—É–∑–µ—Ä–∞)"; const now = new Date(); document.getElementById('date').valueAsDate = now; document.getElementById('time').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0'); render(true); }
function deleteQuick(i) { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –∫–µ—à—É?")) { quickCards.splice(i,1); localStorage.setItem('quick_med_data', JSON.stringify(quickCards)); render(true); } }
async function deleteCard(i) { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) { await directoryHandle.removeEntry(cards[i]._fileName); await loadFiles(); render(); } }
function editCard(i, isQ) { const d = isQ ? quickCards[i] : cards[i]; if(isQ) editQuickIndex=i; else editFileName=d._fileName; fields.forEach(f=>document.getElementById(f).value=d[f]||""); document.getElementById('formArea').classList.remove('hidden'); window.scrollTo(0,0); }
function cancelEdit() { editFileName=null; editQuickIndex=null; fields.forEach(f=>document.getElementById(f).value=""); document.getElementById('vitals').value = "–°–≤—ñ–¥–æ–º—ñ—Å—Ç—å -\n–¢–∏—Å–∫ -\n–ü—É–ª—å—Å -\n–°–∞—Ç—É—Ä–∞—Ü—ñ—è -\n–ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Ö–∞–Ω–Ω—è -"; }
async function saveQuickData() { const d = await getFormData(); if(editQuickIndex!==null) quickCards[editQuickIndex]=d; else quickCards.unshift(d); localStorage.setItem('quick_med_data', JSON.stringify(quickCards)); cancelEdit(); render(true); alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ö–µ—à"); }
function quickViewFile(e) { const f = e.target.files[0]; const r = new FileReader(); r.onload=ev=>showDetails(JSON.parse(ev.target.result), false, true); r.readAsText(f); }
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>